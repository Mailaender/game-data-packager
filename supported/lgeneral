# vim:set ft=sh:

SHORTNAME=lgeneral
LONGNAME="LGeneral"

TGZSUM=40c4be23f60d1dc732aabe13b58fc5e3

lgeneral_usage() {
	echo "game-data-packager ${SHORTNAME} arguments:"
	printf "\tgame-data-packager ${SHORTNAME} [ -f path ] | [ -w ]
\t\t-f file\t\tpath to your tar.gz compressed Panzer General DAT directory\n\
\t\t-w\t\tfetch compressed pg-data.tar.gz from the web\n"
}

verify_args() {
    case $# in
        0)
            lgeneral_usage
            exit 0
            ;;
        1)
            if [ "$1" != "-w" ]; then
                    usage >&2
                    lgeneral_usage >&2
                    exit 1
            fi
            downloadtgz
            ;;
        2)
            if [ "$1" != "-f" ]; then
                usage >&2
                lgeneral_usage >&2
                exit 1
            fi
            downloaded=false
            lgeneraltgz="$2"
            ;;
        *)
            usage >&2
            lgeneral_usage >&2
            exit 1
            ;;
    esac
}

lgeneralmirrors=$LIBDIR/lgeneral-mirrors

downloadtgz() {
    dest="$WORKDIR/pg-data.tar.gz"
    mirror=$(grep -v ^# "$lgeneralmirrors" | sort -R | head -n1)
    for try in $mirror; do
        if wget --progress=dot --directory-prefix "$WORKDIR" -c "$try"
        then
            lgeneraltgz="$dest"
            downloaded=true
            return
        fi
    done
    die "error: could not find pg-data.tar.gz at our chosen mirror"
}

DEBBASE="lgeneral-data-nonfree_${GAME_PACKAGE_VERSION}_all.deb"
DEB="$DATADIR/$DEBBASE"

go() {
	verify_args "$@"
	TGZFILE=`unravel "$lgeneraltgz"`

	verify_file "$TGZFILE"
    	[ -r "$TGZFILE" ] || die "ERROR: '$TGZFILE' cannot be read."

	verify_md5sum_alternatives "$TGZFILE" "$TGZSUM" \
		"warning: checksum is not what we expected"

    	OUTFILE=`unravel "$OUTDIR"`"/$DEBBASE"

	cp -p "$DEB" "$OUTFILE"

	oldpwd=`pwd`

	cd "$WORKDIR"

	# create directory structure required by lgc-pg
	mkdir -p lgeneral/gfx/flags \
	         lgeneral/gfx/terrain \
	         lgeneral/gfx/units \
	         lgeneral/maps/pg \
	         lgeneral/nations \
	         lgeneral/scenarios/pg \
	         lgeneral/sounds/pg \
	         lgeneral/units

	# extract pg-data and convert to lgeneral's native file format
    	tar xfz "$TGZFILE"
    	lgc-pg -s pg-data/ -d lgeneral/
	
	
    	slipstream_dir "$OUTFILE" "usr/share/games/" "lgeneral/"

    if [ "$downloaded" = "true" ]; then
        rm "$TGZFILE"
	rm -rf pg-data/
	rm -rf lgeneral/
    elif [ "$downloaded" = "false" ]; then
	rm -rf pg-data/
	rm -rf lgeneral/
    fi

	cd "$oldpwd"
}
