# vim: set ft=sh:
SHORTNAME=q2rogue
LONGNAME="Quake II Mission Pack: Ground Zero"
pak0sum=5e2ecbe9287152a1e6e0d77b3f47dcb2 # steam as of ~Oct 2013
url=http://deponie.yamagi.org/quake2/quake2-rogue-2.00.tar.xz
sum=9b058f2821fddf8776561ab245cfff85

. $LIBDIR/q2mp-common

go() {
  q2mp_prereqs
  checksum="true"
  xpath=""
  q2mp_process_opts "$@"

  if [ -z "$xpath" ]; then
    xpath="$WORKDIR/$SHORTNAME.tar.xz"
    wget -O "$xpath" "$url"
  fi
  if [ "$checksum" = "true" ]; then
    verify_md5sum "$xpath" "$sum"
  fi
  q2mp_build_gameso "$xpath"

  verify_directory "$root"
  verify_directory "$root/rogue"
  verify_file      "$root/rogue/pak0.pak"
  for i in logo rend reu1_ reu2_ reu3_ reu4_ rintro; do
    verify_file "$root/rogue/video/$i.cin"
  done

  # slipstream_instsize, slipstream_repack assume this naming
  DESTDIR="$WORKDIR/slipstream.unpacked"

  mkdir -p "$DESTDIR/DEBIAN" "$DESTDIR/usr/share/doc/quake2-rogue" \
    "$DESTDIR/usr/share/games/quake2/rogue/video"

  # the source code component
  mv "$WORKDIR/$SHORTNAME/release/game.so" "$DESTDIR/usr/share/games/quake2/rogue"
  mv "$WORKDIR/$SHORTNAME/LICENSE" "$DESTDIR/usr/share/doc/quake2-rogue/LICENSE"
  rm -rf "$WORKDIR/$SHORTNAME"
  if [ -f "$WORKDIR/$SHORTNAME.tar.xz" ]; then
    rm -f "$WORKDIR/$SHORTNAME.tar.xz"
  fi

  # the data components
  cp -p "$root/rogue/pak0.pak" "$DESTDIR/usr/share/games/quake2/rogue"

  for i in logo rend reu1_ reu2_ reu3_ reu4_ rintro; do
    cp -p "$root/rogue/video/$i.cin" "$DESTDIR/usr/share/games/quake2/rogue/video"
  done

  ARCH=`dpkg-architecture -qDEB_BUILD_ARCH`
  echo "Architecture: $ARCH" > "$DESTDIR/DEBIAN/control"
  cat "$DATADIR/quake2/quake2-rogue.control" >> "$DESTDIR/DEBIAN/control"
  cp -p "$DATADIR/quake2-rogue.copyright" "$DESTDIR/usr/share/doc/quake2-rogue/copyright"
  
  if [ "" = "$OUTDIR" ]; then
      OUTFILE="$WORKDIR/out.deb"
  else
      OUTFILE=`unravel "$OUTDIR"`"/quake2-rogue_${GAME_PACKAGE_VERSION}_${ARCH}.deb"
  fi

  debug "building .deb: $OUTFILE"
  ( cd "$WORKDIR" && slipstream_instsize )
  ( cd "$WORKDIR" && slipstream_repack "$OUTFILE" )
  rm -rf "$DESTDIR"
}
