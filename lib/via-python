# vim:set ft=sh sw=4 sts=4 et:

# Data-driven game-data-packager code for Jedi Outcast, Jedi Academy,
# Return to Castle Wolfenstein; hopefully generalizable to others.
#
# Must define SHORTNAME, LONGNAME, deb first.

sum="sha256"

copyin () {
    install -d `dirname "$2"`
    install -m644 "$1" "$2"
}

gdp_data_driven () {
    if [ "$*" = "" ]; then
        set _ --help
        shift
    fi

    (
    export ETCDIR
    export SHORTNAME
    export DATADIR
    export WORKDIR
    PYTHONPATH="$LIBDIR"
    export PYTHONPATH
    if [ -n "${DEBUG:-}" ]; then
        export DEBUG
    fi
    python3 -m game_data_packager "$@"
    exit $?
    )

    if [ "$?" != 0 ]; then
        exit $?
    fi

    # We still do the actual .deb creation in shell, for now

    for DESTDIR in "$WORKDIR"/*.deb.d; do
        deb="${DESTDIR%.deb.d}"
        deb="${DESTDIR##*/}"

        # it had better have a /usr and a DEBIAN directory or something has
        # gone very wrong
        if ! [ -e "$DESTDIR/usr" ]; then
            echo "$DESTDIR/usr not found" >&2
            exit 1
        fi
        if ! [ -e "$DESTDIR/DEBIAN" ]; then
            echo "$DESTDIR/DEBIAN not found" >&2
            exit 1
        fi
    done

    if [ "" = "$OUTDIR" ]; then
        OUTFILE="$WORKDIR/out.deb"
    else
        OUTFILE="$(unravel "$OUTDIR")/${deb}_${VERSION_PREFIX:-}${GAME_PACKAGE_VERSION}_all.deb"
        ln -s "$OUTFILE" "$WORKDIR/out.deb"
    fi

    ( cd "$DESTDIR" && find usr -type f -print0 | xargs -0 md5sum ) > \
        "$WORKDIR/slipstream.unpacked/DEBIAN/md5sums"

    if [ -e "$WORKDIR/DO-NOT-COMPRESS" ]; then
        COMPRESS=no
    fi

    debug "building .deb: $OUTFILE"
    ( cd "$WORKDIR" && slipstream_instsize )
    ( cd "$WORKDIR" && slipstream_repack "$OUTFILE" )

    # Special value to signal that gdp should just install every .deb
    # in $WORKDIR
    OUTFILE="*.deb"

    rm -f "$WORKDIR/DEB_NAME"
    rm -f "$WORKDIR/DO-NOT-COMPRESS"
    rm -fr "$WORKDIR/tmp"
    rm -fr "$DESTDIR"
}
